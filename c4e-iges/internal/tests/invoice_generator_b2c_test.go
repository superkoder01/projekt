package tests

import (
	"context"
	"encoding/json"
	"fmt"
	"github.com/stretchr/testify/mock"
	require2 "github.com/stretchr/testify/require"
	"github.com/stretchr/testify/suite"
	"gitlab.sce-ovoo.pl/ovoo/products/chain4energy/billing/billing.git/pkg/invoice"
	"gitlab.sce-ovoo.pl/ovoo/products/chain4energy/billing/c4e-iges.git/internal/config"
	"gitlab.sce-ovoo.pl/ovoo/products/chain4energy/billing/c4e-iges.git/internal/core/generators"
	"gitlab.sce-ovoo.pl/ovoo/products/chain4energy/billing/c4e-iges.git/internal/mocks"
	"gitlab.sce-ovoo.pl/ovoo/products/chain4energy/billing/commons.git/billing"
	"os"
	"reflect"
	"testing"
	"time"
)

type InvoiceGeneratorB2CTestSuite struct {
	suite.Suite
	ExpectedInvoiceNonVAT billing.InvoiceProsument
	InvoiceEvent          invoice.InvoiceEvent
	Contract              billing.Contract
	Cfg                   *config.AppConfig
}

func (suite *InvoiceGeneratorB2CTestSuite) SetupSuite() {
	invoiceAsString := "{\n\t\"header\": {\n\t\t\"version\": \"1.0.0\",\n\t\t\"provider\": \"keno\",\n\t\t\"content\": {\n\t\t\t\"type\": \"invoice\",\n\t\t\t\"catg\": \"prosument\"\n\t\t}\n\t},\n\t\"payload\": {\n\t\t\"invoiceDetails\": {\n\t\t\t\"number\": \"2022/06/1/SP/1\",\n\t\t\t\"issueDt\": \"2022-07-06T15:15:15+02:00\",\n\t\t\t\"serviceDt\": \"30/06/2022\",\n\t\t\t\"type\": \"VAT\",\n\t\t\t\"customerId\": \"1\",\n\t\t\t\"billingStartDt\": \"01/06/2022\",\n\t\t\t\"billingEndDt\": \"30/06/2022\",\n\t\t\t\"catg\": \"prosument\",\n\t\t\t\"status\": \"issued\"\n\t\t},\n\t\t\"sellerDetails\": {\n\t\t\t\"legalName\": \"Keno Energia Sp. z o.o.\",\n\t\t\t\"displayName\": \"Keno Energia Sp. z o.o.\",\n\t\t\t\"krs\": \"0000935806\",\n\t\t\t\"nip\": \"6312701187\",\n\t\t\t\"regon\": \"520600217\",\n\t\t\t\"bankAccountNumber\": \"31 2290 0005 0000 6000 4316 5540\",\n\t\t\t\"address\": {\n\t\t\t\t\"street\": \"O. Jana Siemińskiego 22\",\n\t\t\t\t\"postCode\": \"44-100\",\n\t\t\t\t\"city\": \"Gliwice\"\n\t\t\t},\n\t\t\t\"contact\": {\n\t\t\t\t\"address\": {\n\t\t\t\t\t\"street\": \"O. Jana Siemińskiego 22\",\n\t\t\t\t\t\"postCode\": \"44-100\",\n\t\t\t\t\t\"city\": \"Gliwice\"\n\t\t\t\t},\n\t\t\t\t\"phoneNumbers\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"type\": \"mobile\",\n\t\t\t\t\t\t\"number\": \"\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"type\": \"fix\",\n\t\t\t\t\t\t\"number\": \"32 230 25 71\"\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\t\"email\": \"biuro@keno-energia.com\",\n\t\t\t\t\"www\": \"www.keno-energia.com\"\n\t\t\t}\n\t\t},\n\t\t\"customerDetails\": {\n\t\t\t\"customerId\": \"1\",\n\t\t\t\"firstName\": \"Grzegorz\",\n\t\t\t\"lastName\": \"Sikora\",\n\t\t\t\"displayName\": \"Grzegorz Sikora\",\n\t\t\t\"address\": {\n\t\t\t\t\"street\": \"Marylskiego 210\",\n\t\t\t\t\"postCode\": \"05-825\",\n\t\t\t\t\"city\": \"Grodzisk Mazowiecki\"\n\t\t\t},\n\t\t\t\"contact\": {\n\t\t\t\t\"address\": {\n\t\t\t\t\t\"street\": \"Marylskiego 210\",\n\t\t\t\t\t\"postCode\": \"05-825\",\n\t\t\t\t\t\"city\": \"Grodzisk Mazowiecki\"\n\t\t\t\t},\n\t\t\t\t\"phoneNumbers\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"type\": \"mobile\",\n\t\t\t\t\t\t\"number\": \"+48987654321\"\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\t\"email\": \"grzegorz.sikora@wp.pl\",\n\t\t\t\t\"www\": \"www.greg.pl\"\n\t\t\t}\n\t\t},\n\t\t\"paymentDetails\": {\n\t\t\t\"bankDetails\": {\n\t\t\t\t\"account\": \"31 2290 0005 0000 6000 4316 5540\"\n\t\t\t},\n\t\t\t\"paymentTitle\": \"nr. ew. 1\",\n\t\t\t\"paymentDueDt\": \"2022-07-20T15:15:15+02:00\"\n\t\t},\n\t\t\"payerDetails\": {\n\t\t\t\"customerId\": \"1\",\n\t\t\t\"firstName\": \"Grzegorz\",\n\t\t\t\"lastName\": \"Sikora\",\n\t\t\t\"displayName\": \"Grzegorz Sikora\",\n\t\t\t\"address\": {\n\t\t\t\t\"street\": \"Marylskiego 210\",\n\t\t\t\t\"postCode\": \"05-825\",\n\t\t\t\t\"city\": \"Grodzisk Mazowiecki\"\n\t\t\t},\n\t\t\t\"contact\": {\n\t\t\t\t\"address\": {\n\t\t\t\t\t\"street\": \"Marylskiego 210\",\n\t\t\t\t\t\"postCode\": \"05-825\",\n\t\t\t\t\t\"city\": \"Grodzisk Mazowiecki\"\n\t\t\t\t},\n\t\t\t\t\"phoneNumbers\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"type\": \"mobile\",\n\t\t\t\t\t\t\"number\": \"+48987654321\"\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\t\"email\": \"grzegorz.sikora@wp.pl\",\n\t\t\t\t\"www\": \"www.greg.pl\"\n\t\t\t}\n\t\t},\n\t\t\"ppeDetails\": [\n\t\t\t{\n\t\t\t\t\"ppeCode\": \"PL_ZEWD_1405012128_06\",\n\t\t\t\t\"ppeName\": \"Sikora Grzegorz\",\n\t\t\t\t\"ppeObName\": \"Sikora Grzegorz\",\n\t\t\t\t\"address\": {\n\t\t\t\t\t\"street\": \"Marylskiego 210\",\n\t\t\t\t\t\"postCode\": \"05-825\",\n\t\t\t\t\t\"city\": \"Grodzisk Mazowiecki\"\n\t\t\t\t},\n\t\t\t\t\"tariffGroup\": \"G11\",\n\t\t\t\t\"contractedPower\": {\n\t\t\t\t\t\"value\": 40,\n\t\t\t\t\t\"unit\": \"kW\"\n\t\t\t\t}\n\t\t\t}\n\t\t],\n\t\t\"activeEnergyConsumed\": {\n\t\t\t\"energySell\": {\n\t\t\t\t\"meters\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Sprzedaż energii elektrycznej\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_00\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"consumption\": 100,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 0.405,\n\t\t\t\t\t\t\t\t\"netVal\": 40.5,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata handlowa\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_01\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 20,\n\t\t\t\t\t\t\t\t\"netVal\": 20,\n\t\t\t\t\t\t\t\t\"vatRate\": 23\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\t\"exciseTax\": 0.5,\n\t\t\t\t\"subtotal\": {\n\t\t\t\t\t\"amount\": 100,\n\t\t\t\t\t\"netVal\": 60.5\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"energyDistribution\": {\n\t\t\t\t\"meters\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata abonamentowa\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_04\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 0.75,\n\t\t\t\t\t\t\t\t\"netVal\": 0.75,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata dystrybucyjna stała\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_03\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 6.56,\n\t\t\t\t\t\t\t\t\"netVal\": 6.56,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata przejściowa\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_07\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 0.33,\n\t\t\t\t\t\t\t\t\"netVal\": 0.33,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata jakościowa\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_08\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"consumption\": 100,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 0.0095,\n\t\t\t\t\t\t\t\t\"netVal\": 0.95,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata dystrybucyjna zmienna\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_02\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"consumption\": 100,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 0.2223,\n\t\t\t\t\t\t\t\t\"netVal\": 22.23,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata OZE\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_05\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"consumption\": 100,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 0.0009,\n\t\t\t\t\t\t\t\t\"netVal\": 0.09,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata kogeneracyjna\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_06\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"consumption\": 100,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 0.0047,\n\t\t\t\t\t\t\t\t\"netVal\": 0.47,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\"itemName\": \"Opłata mocowa\",\n\t\t\t\t\t\t\t\t\"itemCode\": \"ITEM_09\",\n\t\t\t\t\t\t\t\t\"prevMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"01/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"currMeterRead\": {\n\t\t\t\t\t\t\t\t\t\"dt\": \"30/06/2022\"\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\"factor\": 1,\n\t\t\t\t\t\t\t\t\"netUnitPrice\": 13.25,\n\t\t\t\t\t\t\t\t\"netVal\": 13.25,\n\t\t\t\t\t\t\t\t\"vatRate\": 5\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\t\"subtotal\": {\n\t\t\t\t\t\"amount\": 100,\n\t\t\t\t\t\"netVal\": 44.63\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t\"activeEnergyProduced\": {\n\t\t\t\"meters\": [\n\t\t\t\t{\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Odkup energii\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_10\",\n\t\t\t\t\t\t\t\"dateFrom\": \"01/06/2022\",\n\t\t\t\t\t\t\t\"dateTo\": \"30/06/2022\",\n\t\t\t\t\t\t\t\"production\": 90,\n\t\t\t\t\t\t\t\"netVal\": 30.35,\n\t\t\t\t\t\t\t\"grossVal\": 30.35\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"summary\": {\n\t\t\t\t\"production\": 90,\n\t\t\t\t\"netVal\": 30.35,\n\t\t\t\t\"grossVal\": 30.35\n\t\t\t}\n\t\t},\n\t\t\"depositSummary\": {\n\t\t\t\"deposit\": [\n\t\t\t\t{\n\t\t\t\t\t\"ppeCode\": \"PL_ZEWD_1405012128_06\",\n\t\t\t\t\t\"ppeSummary\": {\n\t\t\t\t\t\t\"depositCurrent\": 15.2,\n\t\t\t\t\t\t\"depositConsumed\": 15.2,\n\t\t\t\t\t\t\"depositNext\": 30.35\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"ppeSummaryTotal\": {\n\t\t\t\t\"depositCurrent\": 15.2,\n\t\t\t\t\"depositConsumed\": 15.2,\n\t\t\t\t\"depositNext\": 30.35\n\t\t\t}\n\t\t},\n\t\t\"excessSalesBalance\": {\n\t\t\t\"items\": [\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Wartość sprzedaży energii w bieżącym okresie rozliczeniowym\",\n\t\t\t\t\t\"itemCode\": \"ITEM_12\",\n\t\t\t\t\t\"grossVal\": 42.53\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Środki z depozytu Prosumenta wykorzystane w bieżącym rozliczeniu\",\n\t\t\t\t\t\"itemCode\": \"ITEM_13\",\n\t\t\t\t\t\"grossVal\": -15.2\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"summary\": {\n\t\t\t\t\"grossVal\": 27.33\n\t\t\t}\n\t\t},\n\t\t\"sellSummary\": {\n\t\t\t\"items\": [\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Sprzedaż energii elektrycznej\",\n\t\t\t\t\t\"itemCode\": \"ITEM_00\",\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"netVal\": 40.5,\n\t\t\t\t\t\"taxVal\": 2.03,\n\t\t\t\t\t\"grossVal\": 42.53\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Dystrybucja energii\",\n\t\t\t\t\t\"itemCode\": \"ITEM_11\",\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"netVal\": 44.63,\n\t\t\t\t\t\"taxVal\": 2.23,\n\t\t\t\t\t\"grossVal\": 46.86\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Opłata handlowa\",\n\t\t\t\t\t\"itemCode\": \"ITEM_01\",\n\t\t\t\t\t\"vatRate\": 23,\n\t\t\t\t\t\"netVal\": 20,\n\t\t\t\t\t\"taxVal\": 4.6,\n\t\t\t\t\t\"grossVal\": 24.6\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"total\": {\n\t\t\t\t\"netVal\": 105.13,\n\t\t\t\t\"taxVal\": 8.86,\n\t\t\t\t\"grossVal\": 113.99\n\t\t\t}\n\t\t},\n\t\t\"paymentSummary\": {\n\t\t\t\"items\": [\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Sprzedaż energii elektrycznej\",\n\t\t\t\t\t\"itemCode\": \"ITEM_00\",\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"netVal\": 40.5,\n\t\t\t\t\t\"taxVal\": 2.03,\n\t\t\t\t\t\"grossVal\": 42.53\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Dystrybucja energii\",\n\t\t\t\t\t\"itemCode\": \"ITEM_11\",\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"netVal\": 44.63,\n\t\t\t\t\t\"taxVal\": 2.23,\n\t\t\t\t\t\"grossVal\": 46.86\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Opłata handlowa\",\n\t\t\t\t\t\"itemCode\": \"ITEM_01\",\n\t\t\t\t\t\"vatRate\": 23,\n\t\t\t\t\t\"netVal\": 20,\n\t\t\t\t\t\"taxVal\": 4.6,\n\t\t\t\t\t\"grossVal\": 24.6\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemName\": \"Uwzględniona nadwyżka\",\n\t\t\t\t\t\"itemCode\": \"ITEM_14\",\n\t\t\t\t\t\"netVal\": -15.2,\n\t\t\t\t\t\"grossVal\": -15.2\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"total\": {\n\t\t\t\t\"netVal\": 89.93,\n\t\t\t\t\"taxVal\": 8.86,\n\t\t\t\t\"grossVal\": 98.79\n\t\t\t}\n\t\t},\n\t\t\"energyValueAnnualBalance\": {\n\t\t\t\"history\": [\n\t\t\t\t{\n\t\t\t\t\t\"ppeCode\": \"PL_ZEWD_1405012128_06\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Wartość energii pobranej z sieci\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_15\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t200,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t100,\n\t\t\t\t\t\t\t\t90,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t42.53\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Wartość energii wprowadzonej do sieci\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_16\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t10,\n\t\t\t\t\t\t\t\t50,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t45,\n\t\t\t\t\t\t\t\t10.2,\n\t\t\t\t\t\t\t\t30.35\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Środki na depozycie Prosumenta\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_17\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t10,\n\t\t\t\t\t\t\t\t50,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t45,\n\t\t\t\t\t\t\t\t15.2\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Środki wykorzystane z depozytu Prosumenta\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_18\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t10,\n\t\t\t\t\t\t\t\t50,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t15.2\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Wartość energii wprowadzonej do sieci jaka pozostała do wykorzystania w danym miesiącu\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_19\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t30.35\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t\"energyAmountAnnualBalance\": {\n\t\t\t\"history\": [\n\t\t\t\t{\n\t\t\t\t\t\"ppeCode\": \"PL_ZEWD_1405012128_06\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Ilość energii pobranej z sieci\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_20\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t200,\n\t\t\t\t\t\t\t\t70,\n\t\t\t\t\t\t\t\t100,\n\t\t\t\t\t\t\t\t90,\n\t\t\t\t\t\t\t\t30,\n\t\t\t\t\t\t\t\t100\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Ilość energii wprowadzonej do sieci\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_21\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t10,\n\t\t\t\t\t\t\t\t50,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t45,\n\t\t\t\t\t\t\t\t30,\n\t\t\t\t\t\t\t\t90\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Suma energii wprowadzonej do sieci jaka pozostaje do wykorzystania\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_22\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t10,\n\t\t\t\t\t\t\t\t50,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t45,\n\t\t\t\t\t\t\t\t45\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Ilość wprowadzonej energii do sieci wykorzystanej\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_23\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t10,\n\t\t\t\t\t\t\t\t50,\n\t\t\t\t\t\t\t\t40,\n\t\t\t\t\t\t\t\t30,\n\t\t\t\t\t\t\t\t45\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"itemName\": \"Ilość energii wprowadzonej do sieci jaka pozostała do wykorzystania w danym miesiącu\",\n\t\t\t\t\t\t\t\"itemCode\": \"ITEM_24\",\n\t\t\t\t\t\t\t\"periods\": [\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t\t90\n\t\t\t\t\t\t\t]\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t\"ppeSummary\": {\n\t\t\t\"items\": [\n\t\t\t\t{\n\t\t\t\t\t\"ppeCode\": \"PL_ZEWD_1405012128_06\",\n\t\t\t\t\t\"value\": 98.79,\n\t\t\t\t\t\"energyConsumed\": 100,\n\t\t\t\t\t\"energyProduced\": 90\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"total\": {\n\t\t\t\t\"value\": 98.79,\n\t\t\t\t\"energyConsumed\": 100,\n\t\t\t\t\"energyProduced\": 90\n\t\t\t}\n\t\t}\n\t}\n}"
	json.Unmarshal([]byte(invoiceAsString), &suite.ExpectedInvoiceNonVAT)

	invoiceEventString := "{\n\t\"contract\": \"GSv0.1/4/05/07/2022\",\n\t\"startDate\": \"01/06/2022\",\n\t\"endDate\": \"30/06/2022\",\n\t\"serviceAccessPoints\": {\n\t\t\"PL_ZEWD_1405012128_06\": {\n\t\t\t\"excise\": 0.5,\n\t\t\t\"sale\": [\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 0,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 0.405,\n\t\t\t\t\t\"net\": 40.5,\n\t\t\t\t\t\"gross\": 42.53,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"vat\": 2.03,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 2,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 100\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 1,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 20,\n\t\t\t\t\t\"net\": 20,\n\t\t\t\t\t\"gross\": 24.6,\n\t\t\t\t\t\"vatRate\": 23,\n\t\t\t\t\t\"vat\": 4.6,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 0,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 0\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"distribution\": [\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 4,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 0.75,\n\t\t\t\t\t\"net\": 0.75,\n\t\t\t\t\t\"gross\": 0.79,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"vat\": 0.04,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 0,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 0\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 3,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 6.56,\n\t\t\t\t\t\"net\": 6.56,\n\t\t\t\t\t\"gross\": 6.89,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"vat\": 0.33,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 0,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 0\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 7,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 0.33,\n\t\t\t\t\t\"net\": 0.33,\n\t\t\t\t\t\"gross\": 0.35,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"vat\": 0.02,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 0,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 0\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 8,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 0.0095,\n\t\t\t\t\t\"net\": 0.95,\n\t\t\t\t\t\"gross\": 1,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"vat\": 0.05,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 2,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 100\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 2,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 0.2223,\n\t\t\t\t\t\"net\": 22.23,\n\t\t\t\t\t\"gross\": 23.34,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"vat\": 1.11,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 2,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 100\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 5,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 0.0009,\n\t\t\t\t\t\"net\": 0.09,\n\t\t\t\t\t\"gross\": 0.09,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 2,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 100\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 6,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 0.0047,\n\t\t\t\t\t\"net\": 0.47,\n\t\t\t\t\t\"gross\": 0.49,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"vat\": 0.02,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 2,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 100\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 9,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"unitPrice\": 13.25,\n\t\t\t\t\t\"net\": 13.25,\n\t\t\t\t\t\"gross\": 13.91,\n\t\t\t\t\t\"vatRate\": 5,\n\t\t\t\t\t\"vat\": 0.66,\n\t\t\t\t\t\"readType\": 0,\n\t\t\t\t\t\"factor\": {\n\t\t\t\t\t\t\"factorType\": 0,\n\t\t\t\t\t\t\"value\": 1\n\t\t\t\t\t},\n\t\t\t\t\t\"consumed\": 0\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"repurchase\": [\n\t\t\t\t{\n\t\t\t\t\t\"itemCode\": 10,\n\t\t\t\t\t\"meterNumber\": \"12312312\",\n\t\t\t\t\t\"from\": \"01/06/2022\",\n\t\t\t\t\t\"to\": \"30/06/2022\",\n\t\t\t\t\t\"net\": 30.35,\n\t\t\t\t\t\"gross\": 30.35,\n\t\t\t\t\t\"excess\": 90\n\t\t\t\t}\n\t\t\t],\n\t\t\t\"deposit\": {\n\t\t\t\t\"records\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"value\": {\"income\": 200, \"outcome\": 10, \"deposit\": 0, \"usedValue\": 0, \"residualValue\": 0},\n\t\t\t\t\t\t\"amount\": {\"income\": 200, \"outcome\": 10, \"deposit\": 0, \"usedValue\": 0, \"residualValue\": 0}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"value\": {\"income\": 40, \"outcome\": 50, \"deposit\": 10, \"usedValue\": 10, \"residualValue\": 0},\n\t\t\t\t\t\t\"amount\": {\"income\": 70, \"outcome\": 50, \"deposit\": 10, \"usedValue\": 10, \"residualValue\": 0}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"value\": {\"income\": 100, \"outcome\": 40, \"deposit\": 50, \"usedValue\": 50, \"residualValue\": 0},\n\t\t\t\t\t\t\"amount\": {\"income\": 100, \"outcome\": 40, \"deposit\": 50, \"usedValue\": 50, \"residualValue\": 0}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"value\": {\"income\": 90, \"outcome\": 45, \"deposit\": 40, \"usedValue\": 40, \"residualValue\": 0},\n\t\t\t\t\t\t\"amount\": {\"income\": 90, \"outcome\": 45, \"deposit\": 40, \"usedValue\": 40, \"residualValue\": 0}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"value\": {\"income\": 40, \"outcome\": 10.20, \"deposit\": 45, \"usedValue\": 40, \"residualValue\": 0},\n\t\t\t\t\t\t\"amount\": {\"income\": 30, \"outcome\": 30, \"deposit\": 45, \"usedValue\": 30, \"residualValue\": 0}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"value\": {\"income\": 42.53, \"outcome\": 30.35, \"deposit\": 15.20, \"usedValue\": 15.20, \"residualValue\": 30.35},\n\t\t\t\t\t\t\"amount\": {\"income\": 100, \"outcome\": 90, \"deposit\": 45, \"usedValue\": 45, \"residualValue\": 90}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t},\n\t\t\t\"repurchaseDetails\": [\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"0-1\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.651,\n\t\t\t\t\t\"net\": 1.3,\n\t\t\t\t\t\"gross\": 1.3\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"1-2\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.5803,\n\t\t\t\t\t\"net\": 1.16,\n\t\t\t\t\t\"gross\": 1.16\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"2-3\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.55402,\n\t\t\t\t\t\"net\": 1.11,\n\t\t\t\t\t\"gross\": 1.11\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"3-4\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.5425,\n\t\t\t\t\t\"net\": 1.09,\n\t\t\t\t\t\"gross\": 1.09\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"4-5\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.532,\n\t\t\t\t\t\"net\": 1.06,\n\t\t\t\t\t\"gross\": 1.06\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"5-6\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.5383,\n\t\t\t\t\t\"net\": 1.08,\n\t\t\t\t\t\"gross\": 1.08\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"6-7\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.623,\n\t\t\t\t\t\"net\": 1.25,\n\t\t\t\t\t\"gross\": 1.25\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"7-8\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.595,\n\t\t\t\t\t\"net\": 1.19,\n\t\t\t\t\t\"gross\": 1.19\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"8-9\",\n\t\t\t\t\t\"units\": 4,\n\t\t\t\t\t\"unitPrice\": 0.5712,\n\t\t\t\t\t\"net\": 2.28,\n\t\t\t\t\t\"gross\": 2.28\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"9-10\",\n\t\t\t\t\t\"units\": 5,\n\t\t\t\t\t\"unitPrice\": 0.441,\n\t\t\t\t\t\"net\": 2.21,\n\t\t\t\t\t\"gross\": 2.21\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"10-11\",\n\t\t\t\t\t\"units\": 6,\n\t\t\t\t\t\"unitPrice\": 0.36464,\n\t\t\t\t\t\"net\": 2.19,\n\t\t\t\t\t\"gross\": 2.19\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"11-12\",\n\t\t\t\t\t\"units\": 7,\n\t\t\t\t\t\"unitPrice\": 0.3395,\n\t\t\t\t\t\"net\": 2.38,\n\t\t\t\t\t\"gross\": 2.38\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"12-13\",\n\t\t\t\t\t\"units\": 8,\n\t\t\t\t\t\"unitPrice\": 0.3612,\n\t\t\t\t\t\"net\": 2.89,\n\t\t\t\t\t\"gross\": 2.89\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"13-14\",\n\t\t\t\t\t\"units\": 4,\n\t\t\t\t\t\"unitPrice\": 0.31996,\n\t\t\t\t\t\"net\": 1.28,\n\t\t\t\t\t\"gross\": 1.28\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"14-15\",\n\t\t\t\t\t\"units\": 3,\n\t\t\t\t\t\"unitPrice\": 0.315,\n\t\t\t\t\t\"net\": 0.95,\n\t\t\t\t\t\"gross\": 0.95\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"15-16\",\n\t\t\t\t\t\"units\": 4,\n\t\t\t\t\t\"unitPrice\": 0.31996,\n\t\t\t\t\t\"net\": 1.28,\n\t\t\t\t\t\"gross\": 1.28\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"16-17\",\n\t\t\t\t\t\"units\": 5,\n\t\t\t\t\t\"unitPrice\": 0.38514,\n\t\t\t\t\t\"net\": 1.93,\n\t\t\t\t\t\"gross\": 1.93\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"17-18\",\n\t\t\t\t\t\"units\": 7,\n\t\t\t\t\t\"unitPrice\": 0.4263,\n\t\t\t\t\t\"net\": 2.98,\n\t\t\t\t\t\"gross\": 2.98\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"18-19\",\n\t\t\t\t\t\"units\": 4,\n\t\t\t\t\t\"unitPrice\": 0.595,\n\t\t\t\t\t\"net\": 2.38,\n\t\t\t\t\t\"gross\": 2.38\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"19-20\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.728,\n\t\t\t\t\t\"net\": 1.46,\n\t\t\t\t\t\"gross\": 1.46\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"20-21\",\n\t\t\t\t\t\"units\": 1,\n\t\t\t\t\t\"unitPrice\": 0.78365,\n\t\t\t\t\t\"net\": 0.78,\n\t\t\t\t\t\"gross\": 0.78\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"21-22\",\n\t\t\t\t\t\"units\": 2,\n\t\t\t\t\t\"unitPrice\": 0.735,\n\t\t\t\t\t\"net\": 1.47,\n\t\t\t\t\t\"gross\": 1.47\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"22-23\",\n\t\t\t\t\t\"units\": 4,\n\t\t\t\t\t\"unitPrice\": 0.7343,\n\t\t\t\t\t\"net\": 2.94,\n\t\t\t\t\t\"gross\": 2.94\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"date\": \"01/06/2022\",\n\t\t\t\t\t\"hourPeriod\": \"23-24\",\n\t\t\t\t\t\"units\": 5,\n\t\t\t\t\t\"unitPrice\": 0.6308,\n\t\t\t\t\t\"net\": 3.15,\n\t\t\t\t\t\"gross\": 3.15\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t}\n}"
	json.Unmarshal([]byte(invoiceEventString), &suite.InvoiceEvent)

	contractString := "{\n    \"Id\": {\"$oid\": \"62c41119c6232c55691fe8a8\"},\n    \"header\": {\n      \"version\": \"1.0.0\",\n      \"provider\": \"keno\",\n      \"content\": {\n        \"type\": \"contract\",\n        \"catg\": \"prosumer\"\n      }\n    },\n    \"payload\": {\n      \"contractDetails\": {\n        \"title\": \"GSv0.1\",\n        \"type\": \"comprehensive\",\n        \"number\": \"GSv0.1/4/05/07/2022\",\n        \"creationDate\": \"05/07/2022\",\n        \"state\": \"accepted\",\n        \"customerId\": \"1\",\n        \"tariffGroup\": \"G11\",\n        \"agreementType\": \"B2C\"\n      },\n      \"sellerDtls\": {\n        \"legalName\": \"Keno Energia Sp. z o.o.\",\n        \"displayName\": \"Keno Energia Sp. z o.o.\",\n        \"krs\": \"0000935806\",\n        \"nip\": \"6312701187\",\n        \"regon\": \"520600217\",\n        \"bankAccountNumber\": \"31 2290 0005 0000 6000 4316 5540\",\n        \"address\": {\n          \"street\": \"O. Jana Siemińskiego 22\",\n          \"postCode\": \"44-100\",\n          \"city\": \"Gliwice\"\n        },\n        \"contact\": {\n          \"address\": {\n            \"street\": \"O. Jana Siemińskiego 22\",\n            \"postCode\": \"44-100\",\n            \"city\": \"Gliwice\"\n          },\n          \"phoneNumbers\": [\n            {\n              \"type\": \"mobile\",\n              \"number\": \"\"\n            },\n            {\n              \"type\": \"fix\",\n              \"number\": \"32 230 25 71\"\n            }\n          ],\n          \"email\": \"biuro@keno-energia.com\",\n          \"www\": \"www.keno-energia.com\"\n        }\n      },\n      \"customerDtls\": {\n        \"customerId\": \"1\",\n        \"firstName\": \"Grzegorz\",\n        \"lastName\": \"Sikora\",\n        \"displayName\": \"Grzegorz Sikora\",\n        \"address\": {\n          \"street\": \"Marylskiego 210\",\n          \"postCode\": \"05-825\",\n          \"city\": \"Grodzisk Mazowiecki\"\n        },\n        \"contact\": {\n          \"address\": {\n            \"street\": \"Marylskiego 210\",\n            \"postCode\": \"05-825\",\n            \"city\": \"Grodzisk Mazowiecki\"\n          },\n          \"phoneNumbers\": [\n            {\n              \"type\": \"mobile\",\n              \"number\": \"+48987654321\"\n            }\n          ],\n          \"email\": \"grzegorz.sikora@wp.pl\",\n          \"www\": \"www.greg.pl\"\n        }\n      },\n      \"conditions\": {\n        \"startDate\": \"05/07/2022\",\n        \"endDate\": \"05/07/2024\",\n        \"duration\": {\n          \"calendarUnit\": \"month\",\n          \"number\": \"24\"\n        },\n        \"billingPeriod\": {\n          \"calendarUnit\": \"month\",\n          \"number\": \"1\"\n        },\n        \"invoiceDueDate\": \"14\",\n        \"estimatedAnnualElectricityConsumption\": {\n          \"unit\": \"MWh\",\n          \"amount\": \"40\"\n        }\n      },\n      \"serviceAccessPoints\": [\n        {\n          \"objectName\": \"Sikora Grzegorz\",\n          \"address\": \"Chęcińska\",\n          \"sapCode\": \"PL_ZEWD_1405012128_06\",\n          \"meterNumber\": \"12312312\",\n          \"osd\": {\n            \"name\": \"ENID\"\n          },\n          \"tariffGroup\": \"G11\",\n          \"estimatedEnergyUsage\": {\n            \"unit\": \"MWh\",\n            \"amount\": \"40\"\n          },\n          \"declaredEnergyUsage\": {\n            \"unit\": \"MWh\",\n            \"amount\": \"40\"\n          },\n          \"connectionPower\": {\n            \"unit\": \"kW\",\n            \"amount\": \"40\"\n          },\n          \"contractedPower\": {\n            \"unit\": \"kW\",\n            \"amount\": \"40\"\n          },\n          \"currentSeller\": {\n            \"name\": \"PGE\",\n            \"noticePeriod\": \"3\"\n          },\n          \"phase\": \"1\",\n          \"sourceType\": \"PV\",\n          \"sourcePower\": {\n            \"unit\": \"kWp\",\n            \"amount\": \"2.42\"\n          }\n        }\n      ],\n      \"priceList\": [\n        {\n          \"name\": \"Super Cennik G11\",\n          \"id\": \"\",\n          \"type\": \"fixed\",\n          \"startDate\": \"12/04/2022\",\n          \"endDate\": \"11/04/2024\",\n          \"osd\": \"ENID\",\n          \"tariffGroup\": \"G11\",\n          \"zones\": [\n            {\n              \"id\": \"1\",\n              \"name\": \"całodobowa\",\n              \"unit\": \"kWh\",\n              \"cost\": \"232.323\",\n              \"currency\": \"pln\"\n            }\n          ],\n          \"commercialFee\": {\n            \"calendarUnit\": \"month\",\n            \"cost\": \"10.0\",\n            \"currency\": \"pln\"\n          }\n        }\n      ],\n      \"repurchase\": {\n        \"name\": \"SuperKenoOdkup\",\n        \"type\": \"rdn\",\n        \"id\": \"CEN1G11T_01.01.2022-31.03.2022\",\n        \"price\": {\n        }\n      }\n    }\n  }"
	json.Unmarshal([]byte(contractString), &suite.Contract)

	os.Setenv("CONFIGPATH", "../../config/")
	suite.Cfg, _ = config.LoadConfig()
}

func (suite *InvoiceGeneratorB2CTestSuite) TearDownSuite() {
}

func (suite *InvoiceGeneratorB2CTestSuite) SetupTest() {
}

func (suite *InvoiceGeneratorB2CTestSuite) TearDownTest() {
}

func (suite *InvoiceGeneratorB2CTestSuite) BeforeTest(suiteName, testName string) {
	fmt.Printf("START: %s.%s\n", suiteName, testName)
}

func (suite *InvoiceGeneratorB2CTestSuite) AfterTest(suiteName, testName string) {
	fmt.Printf("FINISH: %s.%s\n", suiteName, testName)
}

func (suite *InvoiceGeneratorB2CTestSuite) HandleStats(suiteName string, stats *suite.SuiteInformation) {
	fmt.Println("=== Suite Stats:")
	fmt.Printf("=> suite duration: %v [s]\n", stats.End.Sub(stats.Start).Seconds())
	for _, v := range stats.TestStats {
		fmt.Printf("=> %s : %v [s] : %v\n", v.TestName, v.End.Sub(v.Start).Seconds(), passed(v.Passed))
	}
}

//func passed(status bool) string {
//	if status {
//		return fmt.Sprint("PASSED")
//	}
//	return fmt.Sprint("FAILED")
//}

// In order for 'go test' to run this suite, we need to create
// a normal test function and pass our suite to suite.Run
func TestInvoiceGeneratorB2CTestSuite(t *testing.T) {
	suite.Run(t, new(InvoiceGeneratorB2CTestSuite))
}

///////////////////////////////////////////////////////////////////////
func (suite *InvoiceGeneratorB2CTestSuite) TestGenerateInvoiceOK() {
	require := require2.New(suite.T())

	ctx := context.Background()

	tests := []struct {
		invoiceNumber   string
		expectedInvoice *billing.InvoiceProsument
		invoiceEvent    *invoice.InvoiceEvent
		contract        *billing.Contract
	}{
		{"2022/06/1/SP/1", &suite.ExpectedInvoiceNonVAT, &suite.InvoiceEvent, &suite.Contract},
	}

	loggerMock := mocks.NewLogger(suite.T())
	loggerMock.On("Debugf", mock.Anything, mock.Anything, mock.Anything).Maybe()
	loggerMock.On("Warnf", mock.Anything, mock.Anything, mock.Anything).Maybe()
	loggerMock.On("Infof", mock.Anything, mock.Anything, mock.Anything, mock.Anything).Maybe()

	for _, test := range tests {
		invoiceGenerator := generators.NewInvoiceGeneratorB2C(test.contract, test.invoiceEvent, loggerMock, suite.Cfg)
		actualInvoice, actualInvoiceDetails, err := invoiceGenerator.GenerateInvoice(ctx, test.invoiceNumber)

		require.NoError(err, "should not happen")
		require.NotNil(actualInvoice, "for b2c invoice shall be generated")
		require.Nil(actualInvoiceDetails, "for b2c invoice details shall not be generated")

		// Workaround for IssueDt and PaymentDueDt that are dynamically generated
		issueDt, _ := time.Parse(time.RFC3339, "2022-07-06T15:15:15+02:00")
		actualInvoice.Payload.InvoiceDetails.IssueDt = issueDt
		paymentDueDt, _ := time.Parse(time.RFC3339, "2022-07-20T15:15:15+02:00")
		actualInvoice.Payload.PaymentDetails.PaymentDueDt = paymentDueDt

		require.True(reflect.DeepEqual(test.expectedInvoice, actualInvoice))
	}
}
